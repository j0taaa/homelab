name: Deploy Homelab

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: read
    env:
      LOCAL_BIND_IP: ${{ vars.LOCAL_BIND_IP }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Docker config (no credential helper)
        run: |
          # Avoid using the runner's persisted ~/.docker/config.json which may reference
          # a credential helper not available on this OS (e.g. docker-credential-desktop.exe).
          echo "DOCKER_CONFIG=$RUNNER_TEMP/docker-config" >> "$GITHUB_ENV"
          mkdir -p "$RUNNER_TEMP/docker-config"
          if [ ! -f "$RUNNER_TEMP/docker-config/config.json" ]; then
            echo '{}' > "$RUNNER_TEMP/docker-config/config.json"
          fi

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Deploy infrastructure
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          cd infra
          docker compose pull
          docker compose up -d

      - name: Deploy bepasty
        run: |
          cd bepasty
          docker compose pull
          docker compose up -d

      - name: Deploy test-nginx
        run: |
          cd test-nginx
          docker compose pull
          docker compose up -d

      - name: Deploy word-mastermind
        run: |
          cd word-mastermind
          docker compose pull
          docker compose up -d

      - name: Deploy divyde
        run: |
          cd divyde
          docker compose pull
          docker compose up -d

      - name: Cleanup old images
        run: docker image prune -f

