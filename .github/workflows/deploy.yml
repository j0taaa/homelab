name: Deploy Homelab

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Docker config (no credential helper)
        run: |
          # Avoid using the runner's persisted ~/.docker/config.json which may reference
          # a credential helper not available on this OS (e.g. docker-credential-desktop.exe).
          echo "DOCKER_CONFIG=$RUNNER_TEMP/docker-config" >> "$GITHUB_ENV"
          mkdir -p "$RUNNER_TEMP/docker-config"
          if [ ! -f "$RUNNER_TEMP/docker-config/config.json" ]; then
            echo '{}' > "$RUNNER_TEMP/docker-config/config.json"
          fi

      - name: Generate .env file
        run: |
          cat > .env << 'ENVFILE'
          # Auto-generated by GitHub Actions
          
          # Shared
          shared__base_domain=${{ vars.BASE_DOMAIN || 'jaypussy.site' }}
          shared__tz=${{ vars.TZ || 'Etc/UTC' }}
          
          # Infrastructure
          infra__cf_tunnel_token=${{ secrets.INFRA__CF_TUNNEL_TOKEN }}
          infra__traefik_version=${{ vars.INFRA__TRAEFIK_VERSION || 'v2.11' }}
          infra__traefik_http_port=${{ vars.INFRA__TRAEFIK_HTTP_PORT || '80' }}
          infra__traefik_dashboard_port=${{ vars.INFRA__TRAEFIK_DASHBOARD_PORT || '8080' }}
          infra__portainer_port=${{ vars.INFRA__PORTAINER_PORT || '9000' }}
          infra__local_bind_ip=${{ vars.INFRA__LOCAL_BIND_IP || '127.0.0.1' }}
          infra__docker_socket=${{ vars.INFRA__DOCKER_SOCKET || '/var/run/docker.sock' }}
          
          # Dev Environment
          dev_env__git_user_name=${{ vars.DEV_ENV__GIT_USER_NAME }}
          dev_env__git_user_email=${{ vars.DEV_ENV__GIT_USER_EMAIL }}
          dev_env__github_user=${{ vars.DEV_ENV__GITHUB_USER }}
          dev_env__github_pat=${{ secrets.DEV_ENV__GITHUB_PAT }}
          dev_env__anthropic_api_key=${{ secrets.DEV_ENV__ANTHROPIC_API_KEY }}
          dev_env__vercel_token=${{ secrets.DEV_ENV__VERCEL_TOKEN }}

          # Dashboard
          dashboard__basic_auth=${{ secrets.DASHBOARD__BASIC_AUTH }}
          ENVFILE

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Stop running containers
        run: |
          cd infra
          docker compose --env-file ../.env down
          docker rm -f portainer traefik cloudflared 2>/dev/null || true
          cd ../dev-env
          docker compose --env-file ../.env down
          cd ../bepasty
          docker compose --env-file ../.env down
          cd ../test-nginx
          docker compose --env-file ../.env down
          cd ../word-mastermind
          docker compose --env-file ../.env down
          cd ../divyde
          docker compose --env-file ../.env down
          cd ../jaypussy-site
          docker compose --env-file ../.env down
          cd ../dashboard
          docker compose --env-file ../.env down
          cd ../crafty-controller
          docker compose --env-file ../.env down

      - name: Deploy infrastructure
        run: |
          cd infra
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy dev-env
        run: |
          cd dev-env
          docker compose --env-file ../.env build
          docker compose --env-file ../.env up -d

      - name: Deploy bepasty
        run: |
          cd bepasty
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy test-nginx
        run: |
          cd test-nginx
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy word-mastermind
        run: |
          cd word-mastermind
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy divyde
        run: |
          cd divyde
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy jaypussy-site
        run: |
          cd jaypussy-site
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy dashboard
        run: |
          cd dashboard
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Deploy crafty-controller
        run: |
          cd crafty-controller
          docker compose --env-file ../.env pull
          docker compose --env-file ../.env up -d

      - name: Cleanup old images
        run: docker image prune -f
